import{a as Y,r as v,b as P,c as T,j as o}from"./index-cd4e7e60.js";import{c as B}from"./config-component-props-c0788442.js";import{u as Z}from"./use-controlled-state-7ef61a65.js";import{I}from"./index-429bf8ad.js";import{u as ee}from"./index-737a08aa.js";import{e as V}from"./detect-9e279ab2.js";import{n as F}from"./misc-276e45ca.js";import{I as re}from"./index-db49452e.js";const n=Y("fnx-uploader"),ne=+new Date;let te=0;function E(){return`fn-upload-${ne}-${++te}`}function oe(r,s){if(r&&s){const u=Array.isArray(s)?s:s.split(","),l=r.name||"",c=r.type||"",R=c.replace(/\/.*$/,"");return u.some(m=>{const a=m.trim();if(/^\*(\/\*)?$/.test(m))return!0;if(a.charAt(0)==="."){const h=l.toLowerCase(),d=a.toLowerCase();let w=[d];return(d===".jpg"||d===".jpeg")&&(w=[".jpg","jpeg"]),w.some(C=>h.endsWith(C))}return/\/\*$/.test(a)?R===a.replace(/\/.*$/,""):!!(c===a||/^\w+$/.test(a))})}return!0}const se=r=>r.indexOf("image/")===0;function ae({file:r,content:s}){return s!=null?Promise.resolve(s||void 0):r==null||r.type==null||!se(r.type)?Promise.resolve(void 0):new Promise(u=>{const l=new FileReader;l.onload=c=>{u(c.target.result)},l.readAsDataURL(r)})}const ie=B({file:{},onPreview:F,onBeforeRemove:()=>!0,onRemove:F}),D=v.forwardRef((r,s)=>{const[{file:u,onPreview:l,onBeforeRemove:c,onRemove:R},{className:m,children:a,...h}]=ie(r),d=i=>{i.stopPropagation();const t=c(),p=U=>{U!==!1&&R()};V(t)?t.then(p):p(t)},w=()=>{const{status:i,message:t}=u;if(i==="uploading"||i==="failed"){const p=i==="failed"?o(I,{name:"close-o",className:n("mask-icon")}):o(I.Spinner,{className:n("mask-icon-loading")});return P("div",{className:n("mask"),children:[p,t&&o("div",{className:n("mask-message"),children:t})]})}},C=()=>{const{content:i,url:t,thumbnail:p,name:U}=u,x=a&&o("div",{className:n("preview-cover"),children:a});return p!==!1?o(re,{fit:"cover",src:i||t,className:n("preview-image"),onClick:l,children:x}):P("div",{className:n("file"),onClick:l,children:[o(I,{name:"file-o",className:n("file-icon")}),o("div",{className:n("file-name"),children:U}),x]})},b=()=>{const{status:i,removable:t}=u;if(!(t===!1||i==="uploading"))return o("div",{role:"button",tabIndex:0,className:n("preview-remove"),onClick:d,children:o(I,{name:"cross",className:n("preview-remove-icon")})})};return P("div",{className:T(n("preview"),m),...h,ref:s,children:[C(),w(),b()]})});D.displayName="UploaderPreviewItem";const H=D,le=B({multiple:!1,disabled:!1,showFileList:!0,maxCount:Number.MAX_VALUE,defaultValue:[],onRead:r=>r,onUpload:F,onPreview:F,onRemove:()=>!0,slots:{}}),_=r=>r.uid!=null?r:{...r,uid:E()},S=v.forwardRef((r,s)=>{const u=ee("uploader"),l=v.useRef(null),c=v.useRef(null),[{multiple:R,disabled:m,showFileList:a,maxCount:h,defaultValue:d,onRead:w,onUpload:C,onPreview:b,onRemove:i,slots:t},{onChange:p,capture:U,accept:x,value:$,className:W,children:k,...X}]=le(r);v.useImperativeHandle(s,()=>({element:l.current,input:c.current}));const q=v.useMemo(()=>d.map(e=>_(e)),[d]),z=v.useMemo(()=>$?$.map(e=>_(e)):void 0,[$]),{value:L,onChangeRef:A}=Z({value:z,defaultValue:q,onChange:p}),j=v.useCallback(()=>{const e=c.current;e&&e.value&&(e.value="")},[]),M=e=>{const y=h-L.length;e.length>y&&(e=e.slice(0,y)),Promise.all(e.map(g=>ae(g).catch(()=>{}))).then(g=>{const N=e.map((f,Q)=>({...f,content:f.content!=null?f.content:g[Q]}));j(),C(N),A.current([...L,...N])})},G=e=>{if(m)return;const g=[...e.target.files||[]].filter(f=>oe(f,x)).map(f=>({...f,uid:E(),status:"uploading",file:f}));if(g.length<=0)return;const N=w(g);V(N)?N.then(M).catch(j):M(N)},J=()=>{if(a)return t.fileList||L.map(e=>o(H,{file:e,onPreview:()=>b(e),onBeforeRemove:()=>i(e),onRemove:()=>A.current(L.filter(y=>y.uid!==e.uid)),children:t.filePreviewCover&&t.filePreviewCover(e)},e.uid))},K=()=>{if(L.length>=h)return;const e=o("input",{className:n("input"),ref:c,type:"file",capture:U,multiple:R,disabled:m,onChange:G});return k?P("div",{className:n("input-wrapper"),children:[k,e]}):P("div",{className:n("upload"),children:[o(I,{className:n("upload-icon"),name:"plus"}),o("span",{className:n("upload-text"),children:u.upload}),e]})};return o("div",{className:T(n({disabled:m}),W),...X,ref:l,children:P("div",{className:n("wrapper"),children:[J(),K()]})})});S.displayName="Uploader";const ce=S,ue=ce,O=ue;O.PreviewItem=H;const Ne=O;export{Ne as U};
