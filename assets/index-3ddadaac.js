import{a as Q,r as v,j as n,c as _}from"./index-8b435b75.js";import{c as T}from"./config-component-props-c0788442.js";import{u as Y}from"./use-controlled-state-e2423fe7.js";import{I as U}from"./index-f0ac2a00.js";import{u as Z}from"./index-ebeef9c4.js";import{e as B}from"./detect-9e279ab2.js";import{n as y}from"./misc-276e45ca.js";import{I as ee}from"./index-4251ef01.js";const s=Q("fnx-uploader"),re=+new Date;let ne=0;function E(){return"fn-upload-".concat(re,"-").concat(++ne)}function se(r,o){if(r&&o){const u=Array.isArray(o)?o:o.split(","),l=r.name||"",c=r.type||"",j=c.replace(/\/.*$/,"");return u.some(m=>{const a=m.trim();if(/^\*(\/\*)?$/.test(m))return!0;if(a.charAt(0)==="."){const h=l.toLowerCase(),d=a.toLowerCase();let w=[d];return(d===".jpg"||d===".jpeg")&&(w=[".jpg","jpeg"]),w.some(N=>h.endsWith(N))}return/\/\*$/.test(a)?j===a.replace(/\/.*$/,""):!!(c===a||/^\w+$/.test(a))})}return!0}const te=r=>r.indexOf("image/")===0;function oe({file:r,content:o}){return o!=null?Promise.resolve(o||void 0):r==null||r.type==null||!te(r.type)?Promise.resolve(void 0):new Promise(u=>{const l=new FileReader;l.onload=c=>{u(c.target.result)},l.readAsDataURL(r)})}const ae=T({file:{},onPreview:y,onBeforeRemove:()=>!0,onRemove:y}),V=v.forwardRef((r,o)=>{const[{file:u,onPreview:l,onBeforeRemove:c,onRemove:j},{className:m,children:a,...h}]=ae(r),d=i=>{i.stopPropagation();const t=c(),p=P=>{P!==!1&&j()};B(t)?t.then(p):p(t)},w=()=>{const{status:i,message:t}=u;if(i==="uploading"||i==="failed"){const p=i==="failed"?n.jsx(U,{name:"close-o",className:s("mask-icon")}):n.jsx(U.Spinner,{className:s("mask-icon-loading")});return n.jsxs("div",{className:s("mask"),children:[p,t&&n.jsx("div",{className:s("mask-message"),children:t})]})}},N=()=>{const{content:i,url:t,thumbnail:p,name:P}=u,L=a&&n.jsx("div",{className:s("preview-cover"),children:a});return p!==!1?n.jsx(ee,{fit:"cover",src:i||t,className:s("preview-image"),onClick:l,children:L}):n.jsxs("div",{className:s("file"),onClick:l,children:[n.jsx(U,{name:"file-o",className:s("file-icon")}),n.jsx("div",{className:s("file-name"),children:P}),L]})},I=()=>{const{status:i,removable:t}=u;if(!(t===!1||i==="uploading"))return n.jsx("div",{role:"button",tabIndex:0,className:s("preview-remove"),onClick:d,children:n.jsx(U,{name:"cross",className:s("preview-remove-icon")})})};return n.jsxs("div",{className:_(s("preview"),m),...h,ref:o,children:[N(),w(),I()]})});V.displayName="UploaderPreviewItem";const D=V,ie=T({multiple:!1,disabled:!1,showFileList:!0,maxCount:Number.MAX_VALUE,defaultValue:[],onRead:r=>r,onUpload:y,onPreview:y,onRemove:()=>!0,slots:{}}),M=r=>r.uid!=null?r:{...r,uid:E()},H=v.forwardRef((r,o)=>{const u=Z("uploader"),l=v.useRef(null),c=v.useRef(null),[{multiple:j,disabled:m,showFileList:a,maxCount:h,defaultValue:d,onRead:w,onUpload:N,onPreview:I,onRemove:i,slots:t},{onChange:p,capture:P,accept:L,value:F,className:O,children:$,...W}]=ie(r);v.useImperativeHandle(o,()=>({element:l.current,input:c.current}));const X=v.useMemo(()=>d.map(e=>M(e)),[d]),q=v.useMemo(()=>F?F.map(e=>M(e)):void 0,[F]),{value:R,onChangeRef:b}=Y({value:q,defaultValue:X,onChange:p}),k=v.useCallback(()=>{const e=c.current;e&&e.value&&(e.value="")},[]),A=e=>{const C=h-R.length;e.length>C&&(e=e.slice(0,C)),Promise.all(e.map(x=>oe(x).catch(()=>{}))).then(x=>{const g=e.map((f,K)=>({...f,content:f.content!=null?f.content:x[K]}));k(),N(g),b.current([...R,...g])})},z=e=>{if(m)return;const x=[...e.target.files||[]].filter(f=>se(f,L)).map(f=>({...f,uid:E(),status:"uploading",file:f}));if(x.length<=0)return;const g=w(x);B(g)?g.then(A).catch(k):A(g)},G=()=>{if(a)return t.fileList||R.map(e=>n.jsx(D,{file:e,onPreview:()=>I(e),onBeforeRemove:()=>i(e),onRemove:()=>b.current(R.filter(C=>C.uid!==e.uid)),children:t.filePreviewCover&&t.filePreviewCover(e)},e.uid))},J=()=>{if(R.length>=h)return;const e=n.jsx("input",{className:s("input"),ref:c,type:"file",capture:P,multiple:j,disabled:m,onChange:z});return $?n.jsxs("div",{className:s("input-wrapper"),children:[$,e]}):n.jsxs("div",{className:s("upload"),children:[n.jsx(U,{className:s("upload-icon"),name:"plus"}),n.jsx("span",{className:s("upload-text"),children:u.upload}),e]})};return n.jsx("div",{className:_(s({disabled:m}),O),...W,ref:l,children:n.jsxs("div",{className:s("wrapper"),children:[G(),J()]})})});H.displayName="Uploader";const le=H,ce=le,S=ce;S.PreviewItem=D;const xe=S;export{xe as U};
